import streamlit as st
import pandas as pd
import plotly.express as px

# 1. CONFIGURACI칍N DE LA P츼GINA
st.set_page_config(page_title="Monitor Educativo Coquimbo 2024", layout="wide")

# 2. CARGA DE DATOS
@st.cache_data # Esto hace que la app sea r치pida al no recargar el CSV cada vez
def load_data():
    df = pd.read_csv('tabla_integral_criticos_2024.csv')
    return df

df = load_data()

# 3. INTERFAZ: T칤tulo y Filtros
st.title("游늵 Seguimiento de Establecimientos Cr칤ticos (2019-2024)")
st.markdown("An치lisis de resultados Simce e Indicadores de Desarrollo Personal y Social (IDPS)")

with st.sidebar:
    st.header("Filtros de B칰squeda")
    comuna_sel = st.multiselect("Selecciona Comuna(s):", 
                               options=df['Comuna'].unique(), 
                               default=df['Comuna'].unique())
    
    nivel_2019 = st.selectbox("Filtrar por Categor칤a 2019:", 
                             ["Todos", "INSUFICIENTE", "MEDIO-BAJO"])

# Aplicar Filtros
df_filtered = df[df['Comuna'].isin(comuna_sel)]
if nivel_2019 != "Todos":
    # Filtramos si fue cr칤tico en b치sica o media
    df_filtered = df_filtered[(df_filtered['Cat_2019_Basica'] == nivel_2019) | 
                              (df_filtered['Cat_2019_Media'] == nivel_2019)]

# 4. VISUALIZACIONES PRINCIPALES
col1, col2 = st.columns(2)

with col1:
    st.subheader("Simce 4춿 B치sico: Lectura vs Matem치ticas")
    fig_4b = px.scatter(df_filtered, x="Simce_Lect_4B", y="Simce_Mate_4B",
                        hover_name="Nombre Establecimiento", color="Comuna",
                        size="Autoestima_4B", # El tama침o del punto indica autoestima
                        template="plotly_white")
    st.plotly_chart(fig_4b, use_container_width=True)

with col2:
    st.subheader("Simce II Medio: Lectura vs Matem치ticas")
    fig_2m = px.scatter(df_filtered, x="Simce_Lect_2M", y="Simce_Mate_2M",
                        hover_name="Nombre Establecimiento", color="Comuna",
                        template="plotly_white")
    st.plotly_chart(fig_2m, use_container_width=True)

# 5. TABLA DE DATOS DETALLADA
st.subheader("Detalle General de Establecimientos")
st.dataframe(df_filtered)

# 6. BOT칍N DE DESCARGA
csv = df_filtered.to_csv(index=False).encode('utf-8')
st.download_button(
    label="游닌 Descargar Reporte Filtrado",
    data=csv,
    file_name='reporte_educativo_filtrado.csv',
    mime='text/csv',
)